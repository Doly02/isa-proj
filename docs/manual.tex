\documentclass[a4paper,11pt]{article}

\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage[top=3cm, left=2cm, textwidth=17cm, textheight=24cm]{geometry}
\usepackage{times}
\usepackage{multirow}
\usepackage[ruled, czech, linesnumbered, noline, longend]{algorithm2e}
\usepackage{graphics}
\usepackage{pdflscape}
\usepackage{float}
\usepackage{tabularx}
\usepackage{array}


\usepackage[unicode, hidelinks]{hyperref}
\usepackage[nodayofweek]{datetime}
\usepackage[hyphenbreaks]{breakurl}
\usepackage{csquotes}
 
\begin{document}

\begin{titlepage}
    \begin{center}
        
        \Huge
        \textsc{Vysoké učení technické v~Brně}\\[0.1em]
        
        \huge
        \textsc{Fakulta~informačních technologií}
        
        \vspace*{\stretch{0.382}}
        
        \LARGE
        IMAP Client --\ Manual \\[-0.1em]

        \vspace*{\stretch{0.618}}
    \end{center}
    
    {\Large \today \hfill Tomáš Dolák}
\end{titlepage}

\newpage
\tableofcontents

\newpage
\label{firstpage}
\section{Assignment}
The project assignment in the ISA (Network Applications and Network Administration) subject was 
to create IMAP4rev1 (according to RFC3501), which will be able to communicate only over TCP/IP as well 
as using SLL/TLS - IMAPS. The following program downloads emails from the defined server in the argument 
of the program call and saves them in the output directory. If the path to the output repository 
specified by the argument does not exist, the program creates it on this path.

\section{Implementation Details}
The principles of object-oriented programming have been applied to the program code. The program is 
divided into logical classes such as the \verb!ClientConfig! class - which takes care of the configuration 
of the resulting IMAP client based on the input arguments of the program, which it also processes. 
On the result of the configuration, either an instance of the \verb!NonSecureImapClient! class is created, 
which mediates communication, classically only over TCP/IP, or an instance of the \verb!SecureImapClient! 
class, which also uses SSL/TLS in addition to TCP/IP. Both classes \verb!NonSecureImapClient! and 
\verb!SecureImapClient! inherit basic properties from \verb!BaseImapClient!, which provides features 
that are common to both derived classes, such as generating a TAG, finding the value of the current TAG or translating 
a hostname to an IPv4 address. 

\subsection{Implementation of Client}
The NonSecureImapClient and SecureClient classes are characterized by their very 
similar behavior, at the beginning when the class is instantiated they receive information 
like \verb!MailBox!, \verb!OutputDirectory!, \verb!HeadersOnly! and \verb!NewOnly! as input parameters. 
These parameters are used to define further behavior of the program and their description is given in table below.

\smallskip

\begin{center}
    \vspace{0.5cm} % Space before table
    \begin{tabular}{|c|c|}
        \hline
        \textbf{Parameter} & \textbf{Description} \\
        \hline
        MailBox & Mailbox from which emails will be downloaded \\
        \hline
        OutputDirectory & Specifies where downloaded emails will be stored \\
        \hline
        HeadersOnly & Only header of the emails will be downloaded \\
        \hline
        NewOnly & Only unseen emails will be downloaded \\
        \hline
    \end{tabular}
    \vspace{0.5cm} % Space after table
\end{center}

Then, from the user's point of view, the classes only need to call the Run method with the parameters 
server address, port login and password. This method interacts with the server and its behaviour is as follows.

\subsection{Program's Features}
The program also contains some of the extra features, the first of which is that the client 
saves a special \verb!.uidvalidity! file with the value \verb!UIDVALIDITY! when downloading 
to a specific output directory for the first time, this value is used in case the user wants 
to repeatedly download files to the same \verb!output directory! and have synchronized mailboxes. 
On each subsequent run, the \verb!UIDVALIDITY! value is checked to see if it is the same locally 
(in this \verb!.uidvalidity! file) and on the server, if the values are different, 
it is a sign that the structure of the mailbox on the server has changed (i.e. the emails 
have been removed or moved to another mailbox, etc.) and the output directory needs to be purged 
and the emails downloaded again. This is done to ensure that the locally downloaded emails 
are always synchronized with those on the server. 

\smallskip

The client always needs to have a specific \verb!output directory! to which it will download emails 
from the IMAP server, it can happen that the user specifies his/her own location, but the 
folder on the given path does not exist (for example \verb!-o /Desktop/email/my_mailbox/!) in 
this case the client is able to create the folder on the given path 
(for example \verb!/Desktop/email/my_mailbox/!) and store the emails in it.


\newpage

\subsection{Program Flow}
The behaviour of the program has already been mentioned, this chapter contains a more detailed 
description and the program flow diagram shows the behaviour of the client in graphical form.

The program parses the program arguments at the beginning - find out how the client should be 
configured. Next, a client is created according to the request, which establishes a connection 
to the IMAP server using only \verb!TCP/IP! or a combination of \verb!TCP/IP! with \verb!SSL/TLS!.
If the connection is established, it sends a \verb!LOGIN! command to the server, which should log 
the user in. In case of successful login, the SELECT command selects the \verb!mailbox! from which 
the user wants to download emails (note: the default is \verb!INBOX!), next, the \verb!UIDVALIDITY! 
value is verified against the local copy (if the local copy does not exist in the 
\verb!output directory!, it is created). Then all \verb!UIDs! related to the mailbox are retrieved using 
the \verb!FETCH! command (the collection of retrieved \verb!UIDs! can be influenced by this parameter if the 
\verb!'-n'! argument is used). After the set of \verb!UIDs! is obtained, the email download sequence 
starts, the emails are downloaded one by one and the rest of the communication with the IMAP 
client is removed. Finally, the email is stored in the output directory specified by the 
\verb!'-o'! argument and the client repeats this process with the next email with a UID from 
the set of pending emails.

\begin{figure}[H]
    \centering
    \scalebox{0.5}{
        \includegraphics{program-flow-diagram.eps}
    }
    \caption{Program Flow Diagram}
    \label{figure:program-flow-diagram}
\end{figure}

\newpage
\subsection{Classes}
Here Will Be Description.

\begin{figure}[H]
    \centering
    \scalebox{0.5}{
        \includegraphics{ClientConfig.eps}
    }
    \caption{Program Flow Diagram}
    \label{figure:client-config}
\end{figure}

\begin{figure}[H]
    \centering
    \scalebox{0.4}{
        \includegraphics{ImapClient.eps}
    }
    \caption{Program Flow Diagram}
    \label{figure:imap-clients}
\end{figure}

\newpage

\section{Testing}
The \verb!imapcl! program has also been tested. The testing was performed in two ways, 
the first one was tested using the local implementation of the IMAP server, the second 
way was chosen to test on foreign IMAP servers provided by the school such as eva or merlin.

\subsection{Testing of Local IMAP Servers}
To ensure the correct operation of the program, \texttt{imapcl} was tested using a local 
implementation of the IMAP server. The local IMAP server is available in the repository 
in the tests folder under the name \texttt{imap\_server.py}. The server is implemented in Python 
using the \texttt{os}, \texttt{socket}, \texttt{threading}, \texttt{subprocess}, 
\texttt{time}, and \texttt{signal} libraries and handles all requests from the client 
implementation such as \texttt{LOGIN}, \texttt{FETCH} (fetch support involves responding to 
specific requests such as \texttt{'tag' UID 'x' FETCH BODY[HEADER]} or \texttt{'tag' UID 'x' FETCH BODY[TEXT]} 
where \texttt{'tag'} is specific tag of the request and \texttt{'x'} is UID of the email), 
\texttt{SELECT}, and \texttt{LOGOUT}.

\subsection{Testing of Foreign IMAP Servers}
As a complementary method, testing on foreign IMAP servers provided by the school, such as eva 
or merlin, was chosen to ensure compatibility outside the local environment and to demonstrate 
the usability of the program.

\begin{center}
    \vspace{0.5cm} % Space before table
    \begin{tabularx}{\textwidth}{|>{\raggedright\arraybackslash}p{5cm}|>{\raggedright\arraybackslash}p{1cm}|>{\raggedright\arraybackslash}p{5cm}|>{\raggedright\arraybackslash}X|}
        \hline
        \textbf{Testcase} & \textbf{Server} & \textbf{Expected Output} & \textbf{Program Output} \\
        \hline
        Compilation & eva & Successful compilation. & Successful compilation. \\
        \hline
        Auth. file parsing & eva & Auth. file successfully parsed & Auth. file successfully parsed. \\
        \hline
        Calling \texttt{./imapcl outlook.office365.com -p 143 -a PATH/auth\_file.txt -b INBOX -o PATH/output/} & eva & Downloaded whole emails (including header and body), note: number emails on server was 1739. & Downloaded 1739 from server with headers and bodies. \\
        \hline
        Calling \texttt{./imapcl outlook.office365.com -p 143 -a PATH/auth\_file.txt -b INBOX -o PATH/output/} with changed value of \texttt{.uidvalidity} file & eva & Downloaded whole emails (including header and body) and updated value in \texttt{.uidvalidity} file, note: number emails on server was 1739 & Downloaded 1739 from server with headers and bodies. Updated valued of \texttt{.uidvalidity} file. \\
        \hline
        Calling \texttt{./imapcl outlook.office365.com -p 143 -a PATH/auth\_file.txt -b INBOX -o PATH/output/} and path \texttt{PATH/output/} does not exists & eva & Downloaded whole emails (including header and body) and created output directory in \texttt{PATH/output/} file, note: number emails on server was 1739 & Downloaded 1739 from server with headers and bodies. in output directory \texttt{PATH/output/}. \\
        \hline
        Calling \texttt{./imapcl outlook.office365.com -T -a PATH/auth\_file.txt -b INBOX -o PATH/output/} with changed value of \texttt{.uidvalidity} file & eva & Downloaded whole emails (including header and body) and updated value in \texttt{.uidvalidity} file thru SSL/TLS on port 993, note: number emails on server was 1739 & Downloaded 1739 from server with headers and bodies. Updated valued of \texttt{.uidvalidity} file. Used SSL/TLS on default port 993.\\
        \hline
        Compilation & merlin & Successful Compilation & Successful Compilation \\
        \hline
        Auth. file parsing & merlin & Auth. file successfully parsed & Auth. file successfully parsed. \\
        \hline
    \end{tabularx}
    \vspace{0.5cm} % Space after table
\end{center}

\begin{center}
    \vspace{0.5cm} % Space before table
    \begin{tabularx}{\textwidth}{|>{\raggedright\arraybackslash}p{5cm}|>{\raggedright\arraybackslash}p{1cm}|>{\raggedright\arraybackslash}p{5cm}|>{\raggedright\arraybackslash}X|}
        \hline
        \textbf{Testcase} & \textbf{Server} & \textbf{Expected Output} & \textbf{Program Output} \\
        \hline
        Calling \texttt{./imapcl eva.fit.vutbr.cz -p 143 -a PATH/auth\_file.txt -b INBOX -o PATH/output/} & merlin & Downloaded whole emails (including header and body), note: number emails on server was 2349. & Downloaded 2349 from server with headers and bodies. \\
        \hline
        Calling \texttt{./imapcl eva.fit.vutbr.cz -p 143 -h -a PATH/auth\_file.txt -b INBOX -o PATH/output/} & merlin & Downloaded email only headers, note: number emails on server was 2349. & Downloaded 2349 email headers from server. \\
        \hline
        Calling \texttt{./imapcl eva.fit.vutbr.cz -p 143 -n -a PATH/auth\_file.txt -b INBOX -o PATH/output/} & merlin & Downloaded email only new emails (headers + bodies), note: number emails on server was 56. & Downloaded 56 new emails from server with headers and bodies. \\
        \hline
        Calling \texttt{./imapcl eva.fit.vutbr.cz -p 143 -h -n -a PATH/auth\_file.txt -b INBOX -o PATH/output/} & merlin & Downloaded email only new emails (only headers), note: number emails on server was 56. & Downloaded 56 headers of new emails from server. \\
        \hline
        Calling \texttt{./imapcl eva.fit.vutbr.cz -g 143 -h -n -a PATH/auth\_file.txt -b INBOX -o PATH/output/} & merlin & Wrong argument \texttt{-g}, help on terminal should be printed. & Printed help to the user on terminal. \\
        \hline
        Calling \texttt{./imapcl eva.fit.vutbr.cz -p 143} & merlin & A small number of arguments for calling the program. The error message should be displayed to the user. & Displayed the error message that informs user a small number of arguments for calling the program that were used.\\
        \hline
    \end{tabularx}
    \vspace{0.5cm} % Space after table
\end{center}

\newpage

\section{Return Codes}
The program is designed in such a way that in case of an error or failure, the user 
is always informed about the situation that has occurred. In case of success the program 
always returns the return value 0 (respectively \verb!SUCCESS!), in other cases the program gives the return 
values according to the table below.

\begin{center}
    \vspace{0.5cm} % % Space before table
    \begin{tabularx}{\textwidth}{|>{\raggedright\arraybackslash}p{6.5cm}|>{\raggedright\arraybackslash}p{2cm}|>{\raggedright\arraybackslash}p{1.5cm}|>{\raggedright\arraybackslash}X|}
        \hline
        \textbf{Name} & \textbf{Data Type} & \textbf{Value} & \textbf{Description} \\
        \hline
        OUTPUT\_DIR\_NOT\_CREATED & int & -7 & Output Directory Could Not Be Created \\
        \hline
        UIDVALIDITY\_FILE\_NOT\_FOUND & int & -6 & .uidvalidity File Not Found \\
        \hline
        UIDVALIDITY\_FILE\_ERROR & int & -5 & Error With .uidvalidity File (Invalid Format, Out of Range) \\
        \hline
        CREATE\_CONNECTION\_FAILED & int & -4 & Failed to Create Connection With IMAP Server \\
        \hline
        SSL\_CERT\_VERIFICATION\_FAILED & int & -3 & SSL Certificate Verification Failed \\
        \hline
        FETCH\_EMAIL\_FAILED & int & -2 & Fetching Email By UID Failed \\
        \hline
        SUCCESS & int & 0 & Operation Was Successful \\
        \hline
        NO\_IP\_ADDR\_FOUND & int & 1 & No IPv4 Address Was Found \\
        \hline
        PARSE\_ARGUMENTS\_FAILED & int & 2 & Parsing Program's Arguments Failed \\
        \hline
        PARSE\_CREDENTIALS\_FAILED & int & 3 & Parsing Credentials Failed \\
        \hline
        SERVER\_UNKNOWN\_RESPONSE & int & 4 & Server Sent an Unknown Response \\
        \hline
        TRANSMIT\_DATA\_FAILED & int & 5 & Transmission of Data Failed \\
        \hline
        RECEIVE\_DATA\_FAILED & int & 6 & Reception of Data Failed \\
        \hline
        RESPONSE\_NOT\_FOUND & int & 7 & Expected Server's Response Was Not Found \\
        \hline
        PARSE\_BY\_REGEX\_FAILED & int & 8 & Parsing of Regular Expression Failed \\
        \hline
        NON\_UIDS\_RECEIVED & int & 9 & No UIDs Were Received From The IMAP Server \\
        \hline
        CONTINUE\_IN\_RECEIVING & int & 10 & Continue Receiving More Data \\
        \hline
        UNDEFINED\_STATE & int & 11 & Undefined State Encountered \\
        \hline
        UID\_VALIDITY\_ERROR\_IN\_RECV & int & 14 & Unable to Receive UIDVALIDITY From The Server \\
        \hline
        REMOVAL\_OF\_EMAILS\_FAILED & int & 15 & Failed to Remove Emails When UIDVALIDITY Does Not Match \\
        \hline
        BAD\_RESPONSE & string & "Bad Response :(" & Error During Receiving of Server's Response \\
        \hline
    \end{tabularx}
    \vspace{0.5cm} % Space after table
\end{center}


\bibliographystyle{unsrt}
\bibliography{resources}      
\end{document}
